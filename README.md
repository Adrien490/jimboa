# üéÆ Jimboa

**Un jeu social quotidien pour groupes priv√©s**

[![Website](https://img.shields.io/badge/Website-jimboa.fr-blue)](https://jimboa.fr)
[![Status](https://img.shields.io/badge/Status-En%20d√©veloppement-yellow)]()

> Jimboa propose un prompt quotidien (question, vote, challenge) √† un groupe priv√©. Chaque membre peut publier texte/m√©dia, commenter, r√©agir et voter. √Ä la fermeture, la manche est archiv√©e et reste consultable par le groupe.

---

## üìã Table des mati√®res

- [üéØ Vision & Concept](#-vision--concept)
- [üë• Proposition de valeur](#-proposition-de-valeur--personas)
- [üé≤ R√®gles du jeu](#-r√®gles-de-jeu--boucle-quotidienne)
- [‚ú® Fonctionnalit√©s cl√©s](#-fonctionnalit√©s-cl√©s-p√©rim√®tre-v1)
- [üóÑÔ∏è Mod√®le de donn√©es](#Ô∏è-mod√®le-de-donn√©es-erd)
- [üîî Notifications](#-notifications--pr√©f√©rences)
- [üìù User Stories](#-user-stories-backlog)
- [‚öôÔ∏è Workflow d'orchestration](#Ô∏è-workflow-dorchestration-jobs)
- [üé® Parcours UX](#-parcours-ux-prioritaires)
- [üóìÔ∏è Roadmap](#Ô∏è-roadmap--jalons)
- [‚ö†Ô∏è Risques & Garde-fous](#Ô∏è-risques--garde-fous)
- [üìñ Glossaire](#-glossaire)

## üéØ Vision & Concept

**Jimboa** transforme la routine quotidienne en moment de connexion sociale √† travers des prompts engageants.

### üåü Positionnement

- **L√©ger** : Rituel simple de 5-10 minutes par jour
- **Intime** : Groupes priv√©s (amis proches, couples)
- **Fun** : Prompts vari√©s et interactions spontan√©es
- **Sans pression** : Pas de classement global ni de m√©triques intrusives

### üé™ Concept central

Chaque jour, un prompt unique (question, vote, challenge) est propos√© au groupe. Les membres participent librement avec du texte/m√©dia, commentent et r√©agissent en temps r√©el. √Ä la fermeture, la manche est archiv√©e et reste consultable avec tout son contenu.

## üë• Proposition de valeur & Personas

### üéØ Personas cibles

#### üë´ Amis proches

- **Besoin** : Garder le lien au quotidien avec un rituel simple et amusant
- **Contexte** : Vies charg√©es, envie de maintenir la proximit√© sans contrainte

#### üíë Couples

- **Besoin** : Entretenir complicit√© et conversation l√©g√®re sans pression
- **Contexte** : Routine quotidienne, recherche de nouveaux sujets de discussion

### üé™ Jobs-to-be-done

> _"Je veux un micro-rituel social quotidien qui ne demande pas d'organisation."_

> _"Je veux des sujets qui nous ressemblent, sans bruit ni algorithmes opaques."_

## üé≤ R√®gles de jeu & Boucle quotidienne

### ‚è∞ Cycle quotidien

```mermaid
graph LR
    A[üìÖ Planification] --> B[üîî Ouverture + Notif]
    B --> C[‚úçÔ∏è Participation]
    C --> D[üí¨ Interactions]
    D --> E[üó≥Ô∏è Vote si applicable]
    E --> F[‚è∞ Rappel]
    F --> G[üîí Fermeture]
    G --> H[üìö Archive consultable]
```

### üìã R√®gles fondamentales

1. **Planification automatique** : Cr√©ation automatique toutes les 24h √† l'heure locale du groupe
2. **Ouverture** : Notification automatique √† tous les membres (si autoris√©e)
3. **Participation** : Soumissions visibles apr√®s avoir soumis sa propre r√©ponse
4. **Interactions** : Commentaires, r√©actions et votes visibles apr√®s avoir soumis
5. **Vote** : Si type="vote", 1 vote par personne maximum (auto‚Äëvote autoris√©)
6. **Fermeture** : Archivage automatique ‚Üí consultation en lecture seule

## ‚ú® Fonctionnalit√©s cl√©s (P√©rim√®tre v1)

### üë• Gestion des groupes

- **Types** : `friends` ou `couple`
- **R√¥les** : `owner` unique / `admin` / `member`
- **Invitations** : Code permanent modifiable, g√©n√©r√© automatiquement
- **Nom et image modifiables** : Nom et avatar personnalisables par owner/admin
  - Formats support√©s : JPEG, PNG, WebP
  - Taille maximale : 2MB
  - Redimensionnement automatique vers plusieurs tailles
  - Suppression en cascade lors de la suppression du groupe
- **Authentification** : Google OAuth uniquement
- **Configuration** : Email du cr√©ateur d√©fini via `APP_CREATOR_EMAIL` dans `.env`

### üéØ Syst√®me de prompts hybride

- **Banque globale curat√©e** : Catalogue g√©r√© par le cr√©ateur (qualit√©/√©dition)
- **Prompts locaux** : Owners/admins cr√©ent des prompts sp√©cifiques √† leur groupe
- **Suggestions** :
  - Membres ‚Üí banque **locale** (mod√©ration owner/admin)
  - Prompts locaux ‚Üí banque **globale** (mod√©ration app creator)
- **Types** : `question`, `vote`, `challenge`
- **S√©lection quotidienne (v1)** : **Uniquement** parmi les prompts **locaux** actifs (`group_prompts.is_active=true`). La banque globale ne nourrit pas directement la s√©lection v1 ; elle sert de r√©servoir √©ditorial et de provenance de certains prompts locaux.

> _Note : Un mode mixte (local + global approved) pourra √™tre activ√© ult√©rieurement. Les garde‚Äëfous et champs n√©cessaires sont d√©j√† pr√©vus._

### üí¨ Interactions sociales

- **Soumissions** : Texte + m√©dias, 1 par user/manche, d√©finitives
- **Commentaires** : Discussion globale par manche (√©ditables/supprimables jusqu'√† la fermeture)
- **R√©actions** : R√©actions typ√©es sur soumissions et commentaires (1 par type/user/entit√©)
- **Votes** : 1 vote par manche (type "vote"), d√©finitif, auto‚Äëvote autoris√©
- **Visibilit√© conditionnelle** : Tout (soumissions, commentaires, r√©actions, votes) devient visible apr√®s sa propre soumission

### üîî Notifications intelligentes

- **Ouverture** : Nouveau prompt disponible (`round_open`)
- **Pr√©f√©rences** : Par utilisateur **et** par groupe

### üìö Consultation des manches

- **Archives** : Toutes les manches ferm√©es restent consultables
- **Lecture seule** : Aucune interaction possible sur les manches ferm√©es

## üóÑÔ∏è Mod√®le de donn√©es (ERD)

### üîó Relations principales

```mermaid
erDiagram
    profiles ||--o{ group_members : "membre de"
    groups ||--|| group_settings : "param√®tres"
    groups ||--o{ group_members : "contient"
    groups ||--o{ daily_rounds : "manches"
    groups ||--o{ group_prompts : "prompts locaux"
    global_prompts ||--o{ group_prompts : "provenance (optionnelle)"
    profiles ||--o{ group_prompt_suggestions : "sugg√®re vers groupe"
    group_prompts ||--o{ global_prompt_suggestions : "sugg√©r√© vers global"
    profiles ||--o{ global_prompt_suggestions : "sugg√®re vers global"
    profiles ||--o{ global_prompts : "cr√©ateur/mod√©rateur"
    profiles ||--o{ group_prompts : "cr√©ateur local"
    daily_rounds ||--o{ submissions : "soumissions"
    daily_rounds ||--o{ round_votes : "votes"
    profiles ||--o{ submissions : "auteur"
    profiles ||--o{ comments : "commentaire"
    profiles ||--o{ reactions : "r√©action"
    profiles ||--o{ round_votes : "voteur"
    daily_rounds ||--o{ comments : "discussion globale"
    submissions ||--o{ submission_media : "m√©dias"
    submissions ||--o{ reactions : "r√©actions sur"
    comments ||--o{ reactions : "r√©actions sur"
    global_prompts ||--o{ prompt_tag_links : "tagg√©"
    group_prompts ||--o{ prompt_tag_links : "tagg√©"
    prompt_tags ||--o{ prompt_tag_links : "tag"
```

### üì± Notifications & Pr√©f√©rences

```mermaid
erDiagram
    profiles ||--o{ user_devices : "appareils"
    profiles ||--o{ user_group_prefs : "pr√©f√©rences"
    groups ||--o{ user_group_prefs : "pour groupe"
    profiles ||--o{ notifications : "destinataire"
    groups ||--o{ notifications : "contexte"
    groups ||--o{ group_ownership_transfers : "transferts de propri√©t√©"
    profiles ||--o{ group_ownership_transfers : "from_user_id (initiateur)"
    profiles ||--o{ group_ownership_transfers : "to_user_id (destinataire)"
```

### üìä Dictionnaire des tables (v1)

#### üë§ Utilisateurs & Groupes

| Table              | Champs principaux                                                                                                                                | Contraintes & remarques                                                                                                |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------- |
| **profiles**       | `id` (=auth), `display_name`, `image_path`, `created_at`, `updated_at`                                                                           | FK ‚Üí `auth.users(id)` ; `display_name` non vide ; avatar Google ou personnalis√©                                        |
| **groups**         | `name`, `type` (`friends`\|`couple`), `owner_id`, `timezone`, `join_enabled`, `join_code`, `image_path`, `is_active`, `created_at`, `updated_at` | `owner_id` ‚Üí `profiles` ; **invariant owner unique** ; `join_code` en clair ; **timezone fig√©** ; index sur `owner_id` |
| **group_members**  | `group_id`, `user_id`, `role` (`owner`\|`admin`\|`member`), `created_at`                                                                         | `UNIQUE(group_id, user_id)` ; **1 seul `owner`** par groupe (index partiel) ; FK vers `groups` et `profiles`           |
| **group_settings** | `group_id` (PK), `drop_time` (HH:MM, nullable pour h√©ritage app), `notifications_enabled` (bool, d√©faut `true`)                                  | 1:1 avec `groups` ; **dur√©e de manche fixe 24h (constante applicative)**                                               |

#### üéØ Prompts & Manches

| Table                         | Champs principaux                                                                                                                                                                                             | Contraintes & remarques                                                                                                             |
| ----------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------- |
| **global_prompts**            | `type` (`question`\|`vote`\|`challenge`), `title`, `body`, `status` (`pending`\|`approved`\|`rejected`\|`archived`), `created_by`, `reviewed_by`, `reviewed_at`, `feedback`, `metadata` (jsonb), `created_at` | Banque globale curat√©e ; **v1 non utilis√©e pour la s√©lection quotidienne** ; historique des modifs                                  |
| **group_prompts**             | `group_id`, `type`, `title`, `body`, `is_active` (bool), `cloned_from_global` (nullable), `created_by`, `metadata` (jsonb), `created_at`, `updated_at`                                                        | Prompts locaux (cr√©√©s par owner/admin). `cloned_from_global` = provenance _optionnelle_ (non clonable en UI v1)                     |
| **group_prompt_suggestions**  | `group_id`, `suggested_by`, `title`, `body`, `type`, `status` (`pending`\|`approved`\|`rejected`), `feedback`, `created_at`, `updated_at`                                                                     | Suggestions **membres ‚Üí banque locale** (mod√©ration owner/admin)                                                                    |
| **global_prompt_suggestions** | `group_prompt_id`, `suggested_by`, `status` (`pending`\|`approved`\|`rejected`), `feedback`, `created_at`, `updated_at`                                                                                       | Suggestions **prompts locaux ‚Üí banque globale** (mod√©ration app creator)                                                            |
| **daily_rounds**              | `group_id`, `group_prompt_id`, `scheduled_for` (DATE), `status` (`scheduled`\|`open`\|`closed`), `open_at` (timestamptz), `close_at` (timestamptz), `created_at`, `updated_at`                                | `UNIQUE(group_id, scheduled_for)` ; **exactement 24h** entre `open_at` et `close_at` ; **pas de lien direct vers `global_prompts`** |
| **submissions**               | `round_id`, `author_id`, `content_text`, `created_at`                                                                                                                                                         | `UNIQUE(round_id, author_id)` ; d√©finitives ; FK vers `daily_rounds` et `profiles`                                                  |
| **submission_media**          | `submission_id`, `storage_path`, `kind` (`image`\|`video`\|`audio`\|`file`), `metadata` (jsonb), `created_at`                                                                                                 | 0..n m√©dias par soumission ; validations de taille/format                                                                           |

#### üí¨ Interactions

| Table           | Champs principaux                                                                     | Contraintes & remarques                                                                             |
| --------------- | ------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------- |
| **comments**    | `round_id`, `author_id`, `body`, `created_at`, `updated_at`, `deleted_at` (NULL)      | √âditables/supprimables **jusqu'√†** la fermeture du round ; discussion globale li√©e √† `daily_rounds` |
| **round_votes** | `round_id`, `voter_id`, `target_user_id`, `reason` (NULL), `created_at`               | `UNIQUE(round_id, voter_id)` ; **auto‚Äëvote autoris√©** ; `reason` libre et optionnel                 |
| **reactions**   | `entity_type` (`submission`\|`comment`), `entity_id`, `user_id`, `type`, `created_at` | `UNIQUE(entity_type, entity_id, user_id, type)` ; r√©actions typ√©es (ex: like, haha, wow‚Ä¶)           |

#### üîî Notifications & Pr√©f√©rences

| Table                         | Champs principaux                                                        | Contraintes & remarques                                                                 |
| ----------------------------- | ------------------------------------------------------------------------ | --------------------------------------------------------------------------------------- |
| **notifications**             | `user_id`, `group_id`, `type`, `payload` (jsonb), `status`, `created_at` | Types: `round_open`‚Ä¶ ; file d'envoi ; `status` (`pending`\|`sent`\|`failed`)            |
| **user_devices**              | `user_id`, `platform` (`ios`\|`android`\|`web`), `token`, `created_at`   | **UNIQUE(token)** ; 1 token ne peut appartenir qu'√† un seul compte                      |
| **user_group_prefs**          | `user_id`, `group_id`, `mute` (bool), `push` (bool)                      | `UNIQUE(user_id, group_id)` ; pr√©f√©rences par groupe                                    |
| **group_ownership_transfers** | `group_id`, `from_user_id`, `to_user_id`, `status`, `created_at`         | Transferts de propri√©t√© avec acceptation ; `status` (`pending`\|`accepted`\|`rejected`) |

#### üè∑Ô∏è Tagging

| Table                | Champs principaux                                  | Contraintes & remarques                                    |
| -------------------- | -------------------------------------------------- | ---------------------------------------------------------- |
| **prompt_tags**      | `id`, `name`                                       | Tags libres (langue, th√®me, ton, difficult√©‚Ä¶)              |
| **prompt_tag_links** | `prompt_id`, `scope` (`global`\|`group`), `tag_id` | Lien polymorphe : (`scope`, `prompt_id`) + `tag_id` unique |

### ‚öñÔ∏è Contraintes m√©tier (DB & applicatif)

- **1 round/jour/groupe** : `UNIQUE(group_id, scheduled_for)`
- **1 soumission/user/round** : `UNIQUE(round_id, author_id)`
- **1 vote/user/round** : `UNIQUE(round_id, voter_id)`
- **Owner unique** : index partiel `UNIQUE(group_id) WHERE role='owner'` dans `group_members`
- **R√©actions typ√©es uniques** : `UNIQUE(entity_type, entity_id, user_id, type)`
- **S√©lection quotidienne v1** : prompts **locaux** avec `is_active=true` ; exclusion des `N` derniers prompts utilis√©s par le groupe (fen√™tre glissante)

### üîê R√®gles de s√©curit√©

- **Appartenance stricte** : Toute action (soumettre/commenter/r√©agir/voter) requiert membership du groupe
- **Owner unique** : Exactement 1 owner par groupe, non r√©voquable sans transfert
- **Fuseau horaire** : D√©fini √† la cr√©ation (non modifiable), planification locale, stockage UTC
- **Prompts √©ligibles v1** : **seulement** `group_prompts.is_active=true`

### üîí Row Level Security (RLS) - Visibilit√© conditionnelle

**Principe** : Les interactions d'une manche ne sont visibles qu'apr√®s avoir soumis sa propre r√©ponse.

#### Politique RLS pour `submissions`

```sql
-- SELECT autoris√© si round ferm√© OU si j'ai d√©j√† soumis
CREATE POLICY "submissions_visibility" ON submissions FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM daily_rounds dr
    WHERE dr.id = submissions.round_id
    AND dr.status = 'closed'
  )
  OR EXISTS (
    SELECT 1 FROM submissions s2
    WHERE s2.round_id = submissions.round_id
    AND s2.author_id = auth.uid()
  )
);
```

#### Politique RLS pour `comments`

```sql
-- SELECT autoris√© si round ferm√© OU si j'ai soumis dans ce round
CREATE POLICY "comments_visibility" ON comments FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM daily_rounds dr
    WHERE dr.id = comments.round_id
    AND dr.status = 'closed'
  )
  OR EXISTS (
    SELECT 1 FROM submissions s
    WHERE s.round_id = comments.round_id
    AND s.author_id = auth.uid()
  )
);
```

#### Politique RLS pour `reactions`

```sql
-- SELECT autoris√© si round ferm√© OU si j'ai soumis dans ce round
CREATE POLICY "reactions_visibility" ON reactions FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM daily_rounds dr
    JOIN submissions sub ON sub.round_id = dr.id
    WHERE (
      (reactions.entity_type = 'submission' AND reactions.entity_id = sub.id)
      OR (reactions.entity_type = 'comment' AND EXISTS (
        SELECT 1 FROM comments c WHERE c.id = reactions.entity_id AND c.round_id = dr.id
      ))
    )
    AND dr.status = 'closed'
  )
  OR EXISTS (
    SELECT 1 FROM daily_rounds dr
    JOIN submissions sub ON sub.round_id = dr.id
    JOIN submissions my_sub ON my_sub.round_id = dr.id AND my_sub.author_id = auth.uid()
    WHERE (
      (reactions.entity_type = 'submission' AND reactions.entity_id = sub.id)
      OR (reactions.entity_type = 'comment' AND EXISTS (
        SELECT 1 FROM comments c WHERE c.id = reactions.entity_id AND c.round_id = dr.id
      ))
    )
  )
);
```

#### Politique RLS pour `round_votes`

```sql
-- SELECT autoris√© si round ferm√© OU si j'ai soumis dans ce round
CREATE POLICY "votes_visibility" ON round_votes FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM daily_rounds dr
    WHERE dr.id = round_votes.round_id
    AND dr.status = 'closed'
  )
  OR EXISTS (
    SELECT 1 FROM submissions s
    WHERE s.round_id = round_votes.round_id
    AND s.author_id = auth.uid()
  )
);
```

### üîê Triggers de contr√¥le temporel

**Objectif** : Emp√™cher l'√©dition/suppression des commentaires apr√®s fermeture du round.

#### Trigger pour `comments`

```sql
-- Fonction de validation
CREATE OR REPLACE FUNCTION check_round_not_closed()
RETURNS TRIGGER AS $$
BEGIN
  -- V√©rifier si le round est ferm√©
  IF EXISTS (
    SELECT 1 FROM daily_rounds dr
    WHERE dr.id = COALESCE(NEW.round_id, OLD.round_id)
    AND dr.status = 'closed'
  ) THEN
    RAISE EXCEPTION 'Cannot modify comments after round is closed';
  END IF;

  RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

-- Trigger BEFORE UPDATE sur comments
CREATE TRIGGER comments_update_check
  BEFORE UPDATE ON comments
  FOR EACH ROW
  EXECUTE FUNCTION check_round_not_closed();

-- Trigger BEFORE DELETE sur comments
CREATE TRIGGER comments_delete_check
  BEFORE DELETE ON comments
  FOR EACH ROW
  EXECUTE FUNCTION check_round_not_closed();
```

#### Triggers pour `round_votes` (votes d√©finitifs + int√©grit√©)

```sql
-- Fonction de validation pour l'appartenance au groupe
CREATE OR REPLACE FUNCTION check_vote_integrity()
RETURNS TRIGGER AS $$
BEGIN
  -- V√©rifier que target_user_id appartient au m√™me groupe que le round
  IF NOT EXISTS (
    SELECT 1 FROM daily_rounds dr
    JOIN group_members gm ON gm.group_id = dr.group_id
    WHERE dr.id = NEW.round_id
    AND gm.user_id = NEW.target_user_id
    AND gm.status = 'active'
  ) THEN
    RAISE EXCEPTION 'Target user must be an active member of the round group';
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Fonction pour bloquer modification des votes
CREATE OR REPLACE FUNCTION prevent_vote_modification()
RETURNS TRIGGER AS $$
BEGIN
  RAISE EXCEPTION 'Votes are definitive and cannot be modified or deleted';
END;
$$ LANGUAGE plpgsql;

-- Trigger BEFORE INSERT pour v√©rifier l'int√©grit√©
CREATE TRIGGER round_votes_integrity_check
  BEFORE INSERT ON round_votes
  FOR EACH ROW
  EXECUTE FUNCTION check_vote_integrity();

-- Triggers BEFORE UPDATE/DELETE pour emp√™cher modification
CREATE TRIGGER round_votes_prevent_update
  BEFORE UPDATE ON round_votes
  FOR EACH ROW
  EXECUTE FUNCTION prevent_vote_modification();

CREATE TRIGGER round_votes_prevent_delete
  BEFORE DELETE ON round_votes
  FOR EACH ROW
  EXECUTE FUNCTION prevent_vote_modification();
```

#### Extension possible pour `reactions`

```sql
-- Trigger similaire pour reactions (si √©dition/suppression autoris√©e)
CREATE TRIGGER reactions_update_check
  BEFORE UPDATE ON reactions
  FOR EACH ROW
  EXECUTE FUNCTION check_round_not_closed_for_reactions();

CREATE TRIGGER reactions_delete_check
  BEFORE DELETE ON reactions
  FOR EACH ROW
  EXECUTE FUNCTION check_round_not_closed_for_reactions();
```

### üóëÔ∏è Suppression en cascade

- **ON DELETE CASCADE** activ√© sur toutes les FK vers `groups.id` :
  - `group_members.group_id` ‚Üí suppression des membres
  - `group_settings.group_id` ‚Üí suppression des param√®tres
  - `daily_rounds.group_id` ‚Üí suppression des manches
  - `group_prompts.group_id` ‚Üí suppression des prompts locaux
  - `group_prompt_suggestions.group_id` ‚Üí suppression des suggestions locales
  - `group_ownership_transfers.group_id` ‚Üí suppression des transferts
  - `user_group_prefs.group_id` ‚Üí suppression des pr√©f√©rences
  - `notifications.group_id` ‚Üí suppression des notifications
- **Suppression Storage asynchrone** : Images de groupe et m√©dias associ√©s supprim√©s en arri√®re-plan
- **Suppression transitive** : Les FK des tables li√©es aux manches sont aussi supprim√©es (submissions, comments, votes, reactions, etc.)

## üîî Notifications & Pr√©f√©rences

### üì® Types de notifications

| Type           | Trigger             | Timing      |
| -------------- | ------------------- | ----------- |
| **round_open** | Ouverture de manche | √Ä `open_at` |

### ‚öôÔ∏è Syst√®me de pr√©f√©rences

```mermaid
flowchart TD
    A[Notification trigger] --> B{group_settings.notifications_enabled?}
    B -->|Non| C[Block√©]
    B -->|Oui| D{user_group_prefs.mute?}
    D -->|Oui| C
    D -->|Non| E{user_group_prefs.push?}
    E -->|Non| F[Email uniquement]
    E -->|Oui| G[Push + Email]
    G --> H[user_devices: ciblage par appareil]
```

## üìù User Stories (r√©f√©rence)

Pour le d√©tail complet des user stories organis√©es par √©piques, voir **`user-stories.md`**.

## ‚öôÔ∏è Workflow d'orchestration (Jobs)

### üîÑ Principes

- **Idempotence stricte** : transitions contr√¥l√©es par `status` + cl√©s uniques
- **Horodatage** : `open_at` et `close_at` calcul√©s en UTC selon le **fuseau du groupe** et `drop_time`
- **Dur√©e fixe** : `close_at = open_at + INTERVAL '24 hours'`
- **Locks** : advisory lock par `group_id` pour √©viter les doubles transitions

### üìÖ Cr√©ation planifi√©e (toutes les heures)

**Objectif** : si la derni√®re manche est `closed` **depuis ‚â• 24h**, cr√©er `scheduled` pour `CURRENT_DATE` (fuseau du groupe), en choisissant un prompt **local actif** non utilis√© r√©cemment.

Pseudo‚ÄëSQL :

```sql
WITH last_closed AS (
  SELECT g.id AS group_id,
         MAX(dr.close_at) AS last_close_at
  FROM groups g
  LEFT JOIN daily_rounds dr ON dr.group_id = g.id
  GROUP BY g.id
), eligible_groups AS (
  SELECT lg.group_id
  FROM last_closed lg
  JOIN groups g ON g.id = lg.group_id
  WHERE g.is_active = TRUE
    AND (lg.last_close_at IS NULL OR lg.last_close_at <= NOW() - INTERVAL '24 hours')
)
INSERT INTO daily_rounds (group_id, group_prompt_id, scheduled_for, status, created_at, updated_at)
SELECT eg.group_id,
       (
         SELECT gp.id FROM group_prompts gp
         WHERE gp.group_id = eg.group_id
           AND gp.is_active = TRUE
           AND gp.id NOT IN (
             SELECT dr.group_prompt_id
             FROM daily_rounds dr
             WHERE dr.group_id = eg.group_id
             ORDER BY dr.scheduled_for DESC
             LIMIT 7 -- fen√™tre glissante anti-r√©p√©tition
           )
         ORDER BY random() LIMIT 1
       ) AS group_prompt_id,
       (NOW() AT TIME ZONE 'UTC')::date AS scheduled_for,
       'scheduled', NOW(), NOW()
FROM eligible_groups eg
ON CONFLICT DO NOTHING;
```

### üîì Ouverture (toutes les 5 min)

**Objectif** : passer `scheduled` ‚Üí `open` √† l'heure locale `drop_time`.

```sql
UPDATE daily_rounds dr
SET status = 'open',
    open_at = NOW(),
    close_at = NOW() + INTERVAL '24 hours',
    updated_at = NOW()
FROM groups g
JOIN group_settings gs ON gs.group_id = g.id
    WHERE dr.group_id = g.id
  AND dr.status = 'scheduled'
  AND (
    -- calcul "il est l'heure" dans le fuseau du groupe
    (NOW() AT TIME ZONE g.timezone)::date >= dr.scheduled_for
    AND to_char(NOW() AT TIME ZONE g.timezone, 'HH24:MI') >= to_char(gs.drop_time, 'HH24:MI')
  );
```

### üîí Fermeture (toutes les 5 min)

```sql
UPDATE daily_rounds
SET status = 'closed', updated_at = NOW()
WHERE status = 'open' AND close_at <= NOW();
```

### üîí Garanties d'int√©grit√©

- **Transitions** : `scheduled ‚Üí open ‚Üí closed` uniquement
- **Index** : `(group_id, scheduled_for)` unique ; index sur `status`, `open_at`, `close_at`
- **Verrous** : advisory lock `pg_try_advisory_lock(group_id)` autour des jobs

## üé® Parcours UX prioritaires

### üöÄ Onboarding (< 2 min)

```mermaid
flowchart LR
    A[üì± Install] --> B{Premier usage?}
    B -->|Oui| C[üÜï Cr√©er groupe]
    B -->|Non| D[üî¢ Code d'invitation]
    C --> E[‚öôÔ∏è Config rapide]
    D --> E
    E --> F[üéâ Pr√™t !]
```

### üè† √âcran principal "Aujourd'hui"

#### **Avant de soumettre sa r√©ponse :**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üéØ PROMPT DU JOUR                     ‚îÇ
‚îÇ  "Quel est votre super‚Äëpouvoir r√™v√©?" ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ  [ ‚úçÔ∏è R√©pondre ]     ‚è∞ Ferme √† 20h00   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üîí Contenu masqu√©                     ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ  Soumettez votre r√©ponse pour voir :   ‚îÇ
‚îÇ  ‚Ä¢ Les r√©ponses des autres membres     ‚îÇ
‚îÇ  ‚Ä¢ La discussion du groupe             ‚îÇ
‚îÇ  ‚Ä¢ Les votes (si applicable)           ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ  üë• 3 membres ont d√©j√† particip√©       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### **Apr√®s avoir soumis sa r√©ponse :**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üéØ PROMPT DU JOUR                     ‚îÇ
‚îÇ  "Quel est votre super‚Äëpouvoir r√™v√©?" ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ  ‚úÖ Votre r√©ponse: "T√©l√©portation!"     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üìù SOUMISSIONS (temps r√©el)           ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ  üë§ Alice: "Lire dans les pens√©es!"    ‚îÇ
‚îÇ  üë§ Bob: "Voler comme Superman"        ‚îÇ
‚îÇ  üë§ Vous: "T√©l√©portation!"             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üó≥Ô∏è VOTES (si applicable)              ‚îÇ
‚îÇ  üë§ Alice: 2 votes                      ‚îÇ
‚îÇ  üë§ Bob: 1 vote                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üí¨ DISCUSSION GLOBALE                 ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ  üë§ Alice: "Excellent choix Bob!"      ‚îÇ
‚îÇ  üë§ Charlie: "Moi j'h√©site encore..."  ‚îÇ
‚îÇ  [ üí¨ Ajouter un commentaire ]         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### üìö Round archiv√© (Consultation)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üìö MANCHE D'HIER - Ferm√©e             ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ  üë§ Bob: "Voler comme Superman"        ‚îÇ
‚îÇ  üí¨ 3 commentaires                      ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ  üë§ Alice: "Lire dans les pens√©es!"    ‚îÇ
‚îÇ  üí¨ 2 commentaires                      ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ  üë§ Charlie: "T√©l√©portation!"          ‚îÇ
‚îÇ  üí¨ 1 commentaire                       ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ  üìä 3 participants, 6 commentaires      ‚îÇ
‚îÇ  üì∏ 2 m√©dias partag√©s                   ‚îÇ
‚îÇ  üîí Ferm√©e - Lecture seule              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## ‚ö†Ô∏è Risques & Garde-fous

### üîí Risques techniques

| Risque                 | Impact                | Mitigation                                                     |
| ---------------------- | --------------------- | -------------------------------------------------------------- |
| **Concurrence jobs**   | üî¥ Corruption donn√©es | Advisory locks + transitions strictes                          |
| **Spam notifications** | üü° UX d√©grad√©e        | Pr√©f√©rences + `notifications_enabled` + ciblage `user_devices` |
| **Surcharge uploads**  | üü° Performance        | Limites taille + compression + CDN                             |
| **Race conditions**    | üî¥ √âtats incoh√©rents  | Transactions + contraintes DB + horodatage explicite           |

### üõ°Ô∏è Risques produit

| Risque                   | Impact                   | Mitigation                                |
| ------------------------ | ------------------------ | ----------------------------------------- |
| **Contenus sensibles**   | üü° Mod√©ration n√©cessaire | Suppression owner/admin (v1)              |
| **Fatigue prompts**      | üü° Engagement baisse     | S√©lection diversifi√©e + banque croissante |
| **Groupes inactifs**     | üü¢ Ressources gaspill√©es | D√©tection + archivage auto                |
| **Abandon utilisateurs** | üü° R√©tention faible      | Onboarding optimis√© + notifications       |

### üìä Monitoring & Alertes

- **M√©triques core** : Participation quotidienne, temps d'ex√©cution des jobs
- **Alertes** : √âchecs jobs, pics d'erreurs, goulets d'√©tranglement
- **Dashboards** : Sant√© syst√®me, usage utilisateurs, performance

## üìö Glossaire

### üéØ Termes m√©tier

| Terme          | D√©finition                                       | Exemple                                   |
| -------------- | ------------------------------------------------ | ----------------------------------------- |
| **Prompt**     | Consigne quotidienne (question, vote, challenge) | "Quel est votre plat pr√©f√©r√© ?"           |
| **Round**      | Manche quotidienne d'un groupe                   | Round du 04/01/2025 pour "Les Copains"    |
| **Soumission** | R√©ponse d'un membre au prompt                    | Texte + image en r√©ponse                  |
| **Archivage**  | Consultation des manches ferm√©es                 | Toutes les contributions restent visibles |

### üë• R√¥les & Permissions

| R√¥le            | Permissions                                                                                         | Contraintes                                          |
| --------------- | --------------------------------------------------------------------------------------------------- | ---------------------------------------------------- |
| **App Creator** | Mod√©ration banque globale + administration syst√®me + acc√®s exclusif banque globale                  | Email d√©fini dans `.env`, seul acc√®s interface admin |
| **Owner**       | Gestion groupe + prompts locaux + mod√©ration suggestions locales (pas d'acc√®s banque globale en v1) | Unique par groupe, non r√©voquable sans transfert     |
| **Admin**       | Prompts locaux + mod√©ration suggestions locales + gestion membres                                   | Nomm√© par owner                                      |
| **Member**      | Participation + interactions + suggestions (vers groupe ET vers global)                             | Par d√©faut                                           |
